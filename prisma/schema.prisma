// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============ ENUMS ============

enum UserRole {
  ROLE_PLATFORM_OWNER
  ROLE_WEDDING_OWNER
}

enum UserStatus {
  PENDING_APPROVAL  // @deprecated - kept for database compatibility, not used in app
  ACTIVE
  SUSPENDED
}

enum PlanTier {
  FREE
  BASIC
  ADVANCED
  PREMIUM
  BUSINESS
}

enum RsvpStatus {
  PENDING
  ACCEPTED
  DECLINED
}

enum NotificationType {
  INVITE
  REMINDER
  CONFIRMATION
  IMAGE_INVITE
}

enum NotificationChannel {
  WHATSAPP
  SMS
  EMAIL
}

enum NotificationStatus {
  PENDING
  SENT
  DELIVERED
  FAILED
}

enum BulkJobStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum BackgroundType {
  COLOR
  IMAGE
  GRADIENT
}

enum CardStyle {
  FLAT
  ELEVATED
  BORDERED
  GLASS
}

enum DateDisplayStyle {
  CARD
  CALENDAR
  MINIMAL
}

// ============ AUTH MODELS (NextAuth Required) ============

model Account {
  id                String   @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?  @db.Text
  access_token      String?  @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?  @db.Text
  session_state     String?
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @default(now()) @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// Email verification tokens for credential-based auth
model EmailVerificationToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String   @map("user_id")
  expires   DateTime
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("email_verification_tokens")
}

// ============ CORE DOMAIN MODELS ============

model User {
  id            String     @id @default(cuid())
  name          String?
  email         String     @unique
  emailVerified DateTime?  @map("email_verified")
  password      String?    // Hashed password for email/password auth
  image         String?
  role          UserRole   @default(ROLE_WEDDING_OWNER)  // Current active role
  roles         UserRole[] @default([ROLE_WEDDING_OWNER]) // All roles user has access to
  status        UserStatus @default(ACTIVE)
  plan          PlanTier   @default(FREE)
  locale        String     @default("he")
  createdAt     DateTime   @default(now()) @map("created_at")
  updatedAt     DateTime   @default(now()) @updatedAt @map("updated_at")

  // Stripe subscription fields
  stripeCustomerId       String?   @unique @map("stripe_customer_id")
  stripeSubscriptionId   String?   @unique @map("stripe_subscription_id")
  stripePriceId          String?   @map("stripe_price_id")
  stripeCurrentPeriodEnd DateTime? @map("stripe_current_period_end")

  // Pending plan change (for scheduled downgrades)
  pendingPlanChange      PlanTier? @map("pending_plan_change")
  pendingPlanChangeDate  DateTime? @map("pending_plan_change_date")

  accounts              Account[]
  sessions              Session[]
  weddingEvents         WeddingEvent[]
  rsvpTemplates         RsvpTemplate[]
  bulkMessageJobs       BulkMessageJob[]
  usageTracking         UsageTracking?
  emailVerificationTokens EmailVerificationToken[]

  @@map("users")
}

// ============ USAGE TRACKING (Per User) ============

model UsageTracking {
  id     String @id @default(cuid())
  userId String @unique @map("user_id")

  // Current billing period usage
  whatsappSent     Int @default(0) @map("whatsapp_sent")
  smsSent          Int @default(0) @map("sms_sent")

  // One-time package additions (purchased separately)
  whatsappBonus    Int @default(0) @map("whatsapp_bonus")
  smsBonus         Int @default(0) @map("sms_bonus")

  // Period tracking
  periodStart      DateTime @default(now()) @map("period_start")
  periodEnd        DateTime? @map("period_end")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("usage_tracking")
}

model WeddingEvent {
  id          String   @id @default(cuid())
  ownerId     String   @map("owner_id")
  title       String
  description String?  @db.Text
  dateTime    DateTime @map("date_time")
  location    String
  venue       String?
  notes       String?  @db.Text
  imageUrl    String?  @map("image_url")
  smsSenderId String?  @map("sms_sender_id") // Alpha Sender ID for SMS (max 11 chars, alphanumeric)
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at")

  // Invitation image for WhatsApp image invitations
  invitationImageUrl      String? @map("invitation_image_url")
  invitationImagePublicId String? @map("invitation_image_public_id")

  owner            User              @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  guests           Guest[]
  rsvpPageSettings RsvpPageSettings?
  messageTemplates MessageTemplate[]
  bulkMessageJobs  BulkMessageJob[]
  tables           WeddingTable[]
  venueBlocks      VenueBlock[]

  @@index([ownerId])
  @@map("wedding_events")
}

model Guest {
  id             String   @id @default(cuid())
  weddingEventId String   @map("wedding_event_id")
  name           String
  phoneNumber    String?  @map("phone_number")
  email          String?
  slug           String   @unique
  side           String?
  groupName      String?  @map("group_name")
  expectedGuests Int      @default(1) @map("expected_guests")
  notes          String?  @db.Text
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @default(now()) @updatedAt @map("updated_at")

  weddingEvent        WeddingEvent         @relation(fields: [weddingEventId], references: [id], onDelete: Cascade)
  rsvp                GuestRsvp?
  notificationLogs    NotificationLog[]
  bulkMessageJobItems BulkMessageJobItem[]
  tableAssignment     TableAssignment?

  @@index([weddingEventId])
  @@index([slug])
  @@map("guests")
}

model GuestRsvp {
  id          String     @id @default(cuid())
  guestId     String     @unique @map("guest_id")
  status      RsvpStatus @default(PENDING)
  guestCount  Int        @default(1) @map("guest_count")
  note        String?    @db.Text
  respondedAt DateTime?  @map("responded_at")
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @default(now()) @updatedAt @map("updated_at")

  guest Guest @relation(fields: [guestId], references: [id], onDelete: Cascade)

  @@map("guest_rsvps")
}

model NotificationLog {
  id               String              @id @default(cuid())
  guestId          String              @map("guest_id")
  type             NotificationType
  channel          NotificationChannel
  status           NotificationStatus  @default(PENDING)
  providerResponse String?             @db.Text @map("provider_response")
  sentAt           DateTime?           @map("sent_at")
  deliveredAt      DateTime?           @map("delivered_at")
  createdAt        DateTime            @default(now()) @map("created_at")

  guest Guest @relation(fields: [guestId], references: [id], onDelete: Cascade)

  @@index([guestId])
  @@index([type, status])
  @@map("notification_logs")
}

model RsvpPageSettings {
  id             String   @id @default(cuid())
  weddingEventId String   @unique @map("wedding_event_id")

  // ============ MODE TOGGLE ============
  advancedMode Boolean @default(false) @map("advanced_mode")

  // ============ BACKGROUND (Simple + Advanced) ============
  backgroundType    BackgroundType @default(IMAGE) @map("background_type")
  backgroundColor   String?        @map("background_color")
  backgroundImage   String?        @db.Text @map("background_image")
  backgroundOverlay Float?         @map("background_overlay")
  backgroundBlur    Int?           @map("background_blur")

  // ============ COLORS (Simple) ============
  primaryColor   String? @map("primary_color")
  secondaryColor String? @map("secondary_color")
  accentColor    String? @map("accent_color")

  // ============ CARD STYLING (Simple) ============
  cardStyle   CardStyle @default(GLASS) @map("card_style")
  cardOpacity Float?    @map("card_opacity")
  cardBlur    Int?      @map("card_blur")

  // ============ TYPOGRAPHY (Simple) ============
  fontFamily String? @map("font_family")

  // ============ DATE DISPLAY (Simple) ============
  dateDisplayStyle DateDisplayStyle @default(CALENDAR) @map("date_display_style")
  showCountdown    Boolean          @default(true) @map("show_countdown")

  // ============ VISIBILITY TOGGLES (Simple) ============
  showGoogleMaps Boolean @default(true) @map("show_google_maps")
  showWaze       Boolean @default(true) @map("show_waze")

  // ============ NAVIGATION URLS ============
  googleMapsUrl String? @map("google_maps_url")
  wazeUrl       String? @map("waze_url")

  // ============ CUSTOM CONTENT (Simple) ============
  welcomeTitle    String? @map("welcome_title")
  welcomeMessage  String? @db.Text @map("welcome_message")
  thankYouMessage String? @db.Text @map("thank_you_message")
  declineMessage  String? @db.Text @map("decline_message")

  // ============ LOCALE ============
  pageLocale String @default("he") @map("page_locale")

  // =====================================================
  // ============ ADVANCED MODE SETTINGS ================
  // =====================================================

  // Card/Container (Advanced)
  cardBackground   String? @map("card_background")
  cardBorderRadius Int?    @map("card_border_radius")
  cardBorderWidth  Int?    @map("card_border_width")
  cardBorderColor  String? @map("card_border_color")
  cardShadow       Boolean @default(true) @map("card_shadow")
  cardPadding      Int?    @map("card_padding")
  cardMaxWidth     Int?    @map("card_max_width")
  textColor        String? @map("text_color")

  // Button Styles (Advanced)
  buttonStyle        String? @map("button_style")
  buttonColor        String? @map("button_color")
  buttonTextColor    String? @map("button_text_color")
  buttonBorderRadius Int?    @map("button_border_radius")
  buttonBorderColor  String? @map("button_border_color")
  buttonShadow       Boolean @default(true) @map("button_shadow")
  buttonSize         String? @map("button_size")

  // Input Styles (Advanced)
  inputBackgroundColor String? @map("input_background_color")
  inputTextColor       String? @map("input_text_color")
  inputBorderColor     String? @map("input_border_color")

  // Text Colors (Advanced)
  titleTextColor    String? @map("title_text_color")
  subtitleTextColor String? @map("subtitle_text_color")
  labelTextColor    String? @map("label_text_color")

  // Guest Counter (Advanced)
  guestCounterBackground  String? @map("guest_counter_background")
  guestCounterTextColor   String? @map("guest_counter_text_color")
  guestCounterAccent      String? @map("guest_counter_accent")
  guestCounterButtonColor String? @map("guest_counter_button_color")

  // RSVP Option Buttons
  rsvpAcceptBackground  String? @map("rsvp_accept_background")
  rsvpAcceptTextColor   String? @map("rsvp_accept_text_color")
  rsvpDeclineBackground String? @map("rsvp_decline_background")
  rsvpDeclineTextColor  String? @map("rsvp_decline_text_color")
  rsvpButtonFontSize    Int?    @map("rsvp_button_font_size")

  // Font Sizes (Advanced)
  titleFontSize    Int? @map("title_font_size")
  subtitleFontSize Int? @map("subtitle_font_size")
  labelFontSize    Int? @map("label_font_size")
  buttonFontSize   Int? @map("button_font_size")

  // Date Card Settings (Advanced)
  dateCardBackground   String?  @map("date_card_background")
  dateCardTextColor    String?  @map("date_card_text_color")
  dateCardAccentColor  String?  @map("date_card_accent_color")
  dateCardBorderRadius Int?     @map("date_card_border_radius")

  // Enhanced Date Card (Advanced)
  dateCardBackgroundImage String?  @db.Text @map("date_card_background_image")
  dateCardOverlay         Float?   @map("date_card_overlay")
  dateCardBlur            Int?     @map("date_card_blur")
  dateCardPadding         Int?     @map("date_card_padding")
  dateCardShadow          Boolean  @default(true) @map("date_card_shadow")
  dateDayFontSize         Int?     @map("date_day_font_size")
  dateMonthFontSize       Int?     @map("date_month_font_size")
  dateYearFontSize        Int?     @map("date_year_font_size")
  // Individual Date Text Colors
  dateDayOfWeekColor      String?  @map("date_day_of_week_color")
  dateDayOfWeekFontSize   Int?     @map("date_day_of_week_font_size")
  dateDayNumberColor      String?  @map("date_day_number_color")
  dateMonthYearColor      String?  @map("date_month_year_color")

  // Welcome Section Text
  welcomeTitleColor       String?  @map("welcome_title_color")
  welcomeTitleFontSize    Int?     @map("welcome_title_font_size")
  welcomeMessageColor     String?  @map("welcome_message_color")
  welcomeMessageFontSize  Int?     @map("welcome_message_font_size")

  // Icon Colors
  timeIconColor           String?  @map("time_icon_color")
  addressIconColor        String?  @map("address_icon_color")

  // Countdown Label Font Size
  countdownLabelFontSize  Int?     @map("countdown_label_font_size")

  // Time Section (Advanced)
  showTimeSection         Boolean @default(true) @map("show_time_section")
  timeSectionBackground   String? @map("time_section_background")
  timeSectionTextColor    String? @map("time_section_text_color")
  timeSectionBorderRadius Int?    @map("time_section_border_radius")
  timeFontSize            Int?    @map("time_font_size")

  // Address Section (Advanced)
  showAddressSection         Boolean @default(true) @map("show_address_section")
  addressSectionBackground   String? @map("address_section_background")
  addressSectionTextColor    String? @map("address_section_text_color")
  addressSectionBorderRadius Int?    @map("address_section_border_radius")
  addressFontSize            Int?    @map("address_font_size")

  // Countdown Section (Advanced)
  countdownSectionBackground   String? @map("countdown_section_background")
  countdownSectionTextColor    String? @map("countdown_section_text_color")
  countdownSectionBorderRadius Int?    @map("countdown_section_border_radius")
  countdownBoxBackground       String? @map("countdown_box_background")
  countdownBoxTextColor        String? @map("countdown_box_text_color")
  countdownLabelColor          String? @map("countdown_label_color")
  countdownNumberFontSize      Int?    @map("countdown_number_font_size")

  // Question Section (Advanced)
  questionSectionBackground   String? @map("question_section_background")
  questionSectionBorderRadius Int?    @map("question_section_border_radius")
  questionTextColor           String? @map("question_text_color")
  questionFontSize            Int?    @map("question_font_size")
  acceptButtonColor           String? @map("accept_button_color")
  acceptButtonTextColor       String? @map("accept_button_text_color")
  declineButtonColor          String? @map("decline_button_color")
  declineButtonTextColor      String? @map("decline_button_text_color")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  weddingEvent WeddingEvent @relation(fields: [weddingEventId], references: [id], onDelete: Cascade)

  @@map("rsvp_page_settings")
}

// ============ RSVP TEMPLATES ============

model RsvpTemplate {
  id          String  @id @default(cuid())
  name        String
  description String? @db.Text
  previewUrl  String? @map("preview_url")
  isSystem    Boolean @default(false) @map("is_system")
  ownerId     String? @map("owner_id")

  // ============ MODE ============
  advancedMode Boolean @default(false) @map("advanced_mode")

  // ============ BACKGROUND ============
  backgroundType    BackgroundType @default(IMAGE) @map("background_type")
  backgroundColor   String?        @map("background_color")
  backgroundImage   String?        @db.Text @map("background_image")
  backgroundOverlay Float?         @map("background_overlay")
  backgroundBlur    Int?           @map("background_blur")

  // ============ COLORS ============
  primaryColor   String? @map("primary_color")
  secondaryColor String? @map("secondary_color")
  accentColor    String? @map("accent_color")

  // ============ CARD STYLING ============
  cardStyle   CardStyle @default(GLASS) @map("card_style")
  cardOpacity Float?    @map("card_opacity")
  cardBlur    Int?      @map("card_blur")

  // ============ TYPOGRAPHY ============
  fontFamily String? @map("font_family")

  // ============ DATE DISPLAY ============
  dateDisplayStyle DateDisplayStyle @default(CALENDAR) @map("date_display_style")
  showCountdown    Boolean          @default(true) @map("show_countdown")

  // ============ VISIBILITY TOGGLES ============
  showGoogleMaps Boolean @default(true) @map("show_google_maps")
  showWaze       Boolean @default(true) @map("show_waze")

  // ============ CUSTOM CONTENT ============
  welcomeTitle    String? @map("welcome_title")
  welcomeMessage  String? @db.Text @map("welcome_message")
  thankYouMessage String? @db.Text @map("thank_you_message")
  declineMessage  String? @db.Text @map("decline_message")

  // ============ LOCALE ============
  pageLocale String @default("he") @map("page_locale")

  // ============ ADVANCED SETTINGS ============
  cardBackground   String? @map("card_background")
  cardBorderRadius Int?    @map("card_border_radius")
  cardBorderWidth  Int?    @map("card_border_width")
  cardBorderColor  String? @map("card_border_color")
  cardShadow       Boolean @default(true) @map("card_shadow")
  cardPadding      Int?    @map("card_padding")
  cardMaxWidth     Int?    @map("card_max_width")
  textColor        String? @map("text_color")

  buttonStyle        String? @map("button_style")
  buttonColor        String? @map("button_color")
  buttonTextColor    String? @map("button_text_color")
  buttonBorderRadius Int?    @map("button_border_radius")
  buttonBorderColor  String? @map("button_border_color")
  buttonShadow       Boolean @default(true) @map("button_shadow")
  buttonSize         String? @map("button_size")

  inputBackgroundColor String? @map("input_background_color")
  inputTextColor       String? @map("input_text_color")
  inputBorderColor     String? @map("input_border_color")

  subtitleTextColor String? @map("subtitle_text_color")
  labelTextColor    String? @map("label_text_color")

  guestCounterBackground String? @map("guest_counter_background")
  guestCounterTextColor  String? @map("guest_counter_text_color")
  guestCounterAccent     String? @map("guest_counter_accent")

  titleFontSize    Int? @map("title_font_size")
  subtitleFontSize Int? @map("subtitle_font_size")
  labelFontSize    Int? @map("label_font_size")
  buttonFontSize   Int? @map("button_font_size")

  dateCardBackground      String?  @map("date_card_background")
  dateCardTextColor       String?  @map("date_card_text_color")
  dateCardAccentColor     String?  @map("date_card_accent_color")
  dateCardBorderRadius    Int?     @map("date_card_border_radius")
  dateCardBackgroundImage String?  @db.Text @map("date_card_background_image")
  dateCardOverlay         Float?   @map("date_card_overlay")
  dateCardBlur            Int?     @map("date_card_blur")
  dateCardPadding         Int?     @map("date_card_padding")
  dateCardShadow          Boolean  @default(true) @map("date_card_shadow")
  dateDayFontSize         Int?     @map("date_day_font_size")
  dateMonthFontSize       Int?     @map("date_month_font_size")
  dateYearFontSize        Int?     @map("date_year_font_size")
  // Individual Date Text Colors (Template)
  dateDayOfWeekColor      String?  @map("date_day_of_week_color")
  dateDayOfWeekFontSize   Int?     @map("date_day_of_week_font_size")
  dateDayNumberColor      String?  @map("date_day_number_color")
  dateMonthYearColor      String?  @map("date_month_year_color")
  // Welcome Section Text (Template)
  welcomeTitleColor       String?  @map("welcome_title_color")
  welcomeTitleFontSize    Int?     @map("welcome_title_font_size")
  welcomeMessageColor     String?  @map("welcome_message_color")
  welcomeMessageFontSize  Int?     @map("welcome_message_font_size")
  // Icon Colors (Template)
  timeIconColor           String?  @map("time_icon_color")
  addressIconColor        String?  @map("address_icon_color")
  // Countdown Label Font Size (Template)
  countdownLabelFontSize  Int?     @map("countdown_label_font_size")

  showTimeSection         Boolean @default(true) @map("show_time_section")
  timeSectionBackground   String? @map("time_section_background")
  timeSectionTextColor    String? @map("time_section_text_color")
  timeSectionBorderRadius Int?    @map("time_section_border_radius")
  timeFontSize            Int?    @map("time_font_size")

  showAddressSection         Boolean @default(true) @map("show_address_section")
  addressSectionBackground   String? @map("address_section_background")
  addressSectionTextColor    String? @map("address_section_text_color")
  addressSectionBorderRadius Int?    @map("address_section_border_radius")
  addressFontSize            Int?    @map("address_font_size")

  countdownSectionBackground   String? @map("countdown_section_background")
  countdownSectionTextColor    String? @map("countdown_section_text_color")
  countdownSectionBorderRadius Int?    @map("countdown_section_border_radius")
  countdownBoxBackground       String? @map("countdown_box_background")
  countdownBoxTextColor        String? @map("countdown_box_text_color")
  countdownLabelColor          String? @map("countdown_label_color")
  countdownNumberFontSize      Int?    @map("countdown_number_font_size")

  questionSectionBackground   String? @map("question_section_background")
  questionSectionBorderRadius Int?    @map("question_section_border_radius")
  questionTextColor           String? @map("question_text_color")
  questionFontSize            Int?    @map("question_font_size")
  acceptButtonColor           String? @map("accept_button_color")
  acceptButtonTextColor       String? @map("accept_button_text_color")
  declineButtonColor          String? @map("decline_button_color")
  declineButtonTextColor      String? @map("decline_button_text_color")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  owner User? @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  @@index([ownerId])
  @@index([isSystem])
  @@map("rsvp_templates")
}

// ============ MESSAGING PROVIDER SETTINGS (Admin Only) ============

model MessagingProviderSettings {
  id String @id @default(cuid())

  // WhatsApp Config (e.g., WhatsApp Business API / Twilio)
  whatsappProvider    String?  @map("whatsapp_provider")
  whatsappApiKey      String?  @map("whatsapp_api_key")
  whatsappApiSecret   String?  @map("whatsapp_api_secret")
  whatsappPhoneNumber String?  @map("whatsapp_phone_number")
  whatsappEnabled     Boolean  @default(false) @map("whatsapp_enabled")

  // WhatsApp Content Templates (Twilio Content API)
  // These are pre-approved template SIDs from Twilio Content API
  // Required for WhatsApp Business API - free-form messages only work within 24h window
  whatsappInviteContentSid       String?  @map("whatsapp_invite_content_sid")       // Template SID for invitation messages
  whatsappReminderContentSid     String?  @map("whatsapp_reminder_content_sid")     // Template SID for reminder messages
  whatsappConfirmationContentSid String?  @map("whatsapp_confirmation_content_sid") // Template SID for confirmation messages
  whatsappImageInviteContentSid  String?  @map("whatsapp_image_invite_content_sid") // Template SID for image invitation messages

  // WhatsApp Template Text (for display to users - read-only)
  // The admin enters the actual template text here so wedding owners can see what will be sent
  whatsappInviteTemplateText      String?  @db.Text @map("whatsapp_invite_template_text")
  whatsappReminderTemplateText    String?  @db.Text @map("whatsapp_reminder_template_text")
  whatsappConfirmationTemplateText String? @db.Text @map("whatsapp_confirmation_template_text")

  // SMS Config (Twilio)
  smsProvider           String?  @map("sms_provider")
  smsApiKey             String?  @map("sms_api_key")
  smsApiSecret          String?  @map("sms_api_secret")
  smsPhoneNumber        String?  @map("sms_phone_number")
  smsMessagingServiceSid String? @map("sms_messaging_service_sid") // Twilio Messaging Service SID (optional, takes priority over phone number)
  smsEnabled            Boolean  @default(false) @map("sms_enabled")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  @@map("messaging_provider_settings")
}

// ============ MESSAGE TEMPLATES (Per Event) ============

model MessageTemplate {
  id             String           @id @default(cuid())
  weddingEventId String           @map("wedding_event_id")
  type           NotificationType
  locale         String           @default("he")
  title          String
  message        String           @db.Text

  // For confirmation type - true = accepted, false = declined
  isAcceptedVariant Boolean @default(false) @map("is_accepted_variant")

  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  weddingEvent WeddingEvent @relation(fields: [weddingEventId], references: [id], onDelete: Cascade)

  @@unique([weddingEventId, type, locale, isAcceptedVariant])
  @@index([weddingEventId])
  @@map("message_templates")
}

// ============ BULK MESSAGE JOBS ============

model BulkMessageJob {
  id             String              @id @default(cuid())
  weddingEventId String              @map("wedding_event_id")
  createdBy      String              @map("created_by")
  messageType    NotificationType
  channel        NotificationChannel?

  // Progress tracking
  status         BulkJobStatus @default(PENDING)
  totalGuests    Int           @map("total_guests")
  processedCount Int           @default(0) @map("processed_count")
  successCount   Int           @default(0) @map("success_count")
  failedCount    Int           @default(0) @map("failed_count")

  // Timing
  startedAt   DateTime? @map("started_at")
  completedAt DateTime? @map("completed_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  // Error info
  errorMessage String? @db.Text @map("error_message")

  weddingEvent WeddingEvent         @relation(fields: [weddingEventId], references: [id], onDelete: Cascade)
  creator      User                 @relation(fields: [createdBy], references: [id])
  items        BulkMessageJobItem[]

  @@index([weddingEventId])
  @@index([createdBy])
  @@index([status])
  @@map("bulk_message_jobs")
}

model BulkMessageJobItem {
  id       String             @id @default(cuid())
  jobId    String             @map("job_id")
  guestId  String             @map("guest_id")
  status   NotificationStatus @default(PENDING)
  attempts Int                @default(0)

  // Result
  sentAt       DateTime? @map("sent_at")
  errorMessage String?   @db.Text @map("error_message")

  job   BulkMessageJob @relation(fields: [jobId], references: [id], onDelete: Cascade)
  guest Guest          @relation(fields: [guestId], references: [id], onDelete: Cascade)

  @@index([jobId])
  @@index([guestId])
  @@index([status])
  @@map("bulk_message_job_items")
}

// ============ SEATING ARRANGEMENT ============

model WeddingTable {
  id             String   @id @default(cuid())
  weddingEventId String   @map("wedding_event_id")
  name           String
  capacity       Int      @default(10)
  positionX      Int?     @map("position_x")
  positionY      Int?     @map("position_y")
  width          Int      @default(100)
  height         Int      @default(100)
  rotation       Int      @default(0)
  shape          String?  @default("circle") // circle, rectangle, rectangleRounded, concave, concaveRounded
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @default(now()) @updatedAt @map("updated_at")

  weddingEvent WeddingEvent      @relation(fields: [weddingEventId], references: [id], onDelete: Cascade)
  assignments  TableAssignment[]

  @@index([weddingEventId])
  @@map("wedding_tables")
}

model TableAssignment {
  id        String   @id @default(cuid())
  tableId   String   @map("table_id")
  guestId   String   @unique @map("guest_id")
  createdAt DateTime @default(now()) @map("created_at")

  table WeddingTable @relation(fields: [tableId], references: [id], onDelete: Cascade)
  guest Guest        @relation(fields: [guestId], references: [id], onDelete: Cascade)

  @@unique([tableId, guestId])
  @@index([tableId])
  @@index([guestId])
  @@map("table_assignments")
}

// ============ VENUE BLOCKS (DJ, Bar, Stage, etc.) ============

model VenueBlock {
  id             String   @id @default(cuid())
  weddingEventId String   @map("wedding_event_id")
  name           String
  type           String   // dj, bar, stage, danceFloor, entrance, photoBooth, buffet, cake, gifts, other
  shape          String   @default("rectangle") // circle, rectangle, rectangleRounded, concave, concaveRounded
  positionX      Int?     @map("position_x")
  positionY      Int?     @map("position_y")
  width          Int      @default(100)
  height         Int      @default(100)
  rotation       Int      @default(0)
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @default(now()) @updatedAt @map("updated_at")

  weddingEvent WeddingEvent @relation(fields: [weddingEventId], references: [id], onDelete: Cascade)

  @@index([weddingEventId])
  @@map("venue_blocks")
}

// ============ CRON JOB LOGS ============

enum CronJobType {
  PLAN_CHANGE
  BULK_MESSAGE
}

enum CronJobStatus {
  SUCCESS
  FAILED
  SKIPPED
}

model CronJobLog {
  id        String        @id @default(cuid())
  jobType   CronJobType   @map("job_type")
  status    CronJobStatus

  // Target user for plan changes
  userId    String?       @map("user_id")
  userEmail String?       @map("user_email")

  // Plan change specific
  fromPlan  PlanTier?     @map("from_plan")
  toPlan    PlanTier?     @map("to_plan")

  // Timing
  scheduledFor DateTime?  @map("scheduled_for")
  executedAt   DateTime   @default(now()) @map("executed_at")

  // Results
  message      String?    @db.Text
  errorDetails String?    @db.Text @map("error_details")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([jobType])
  @@index([status])
  @@index([userId])
  @@index([executedAt])
  @@map("cron_job_logs")
}

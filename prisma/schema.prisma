generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id                String   @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @default(now()) @updatedAt @map("updated_at")
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model EmailVerificationToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String   @map("user_id")
  expires   DateTime
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("email_verification_tokens")
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String   @map("user_id")
  expires   DateTime
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("password_reset_tokens")
}

model User {
  id                      String                   @id @default(cuid())
  name                    String?
  email                   String                   @unique
  emailVerified           DateTime?                @map("email_verified")
  image                   String?
  role                    UserRole                 @default(ROLE_WEDDING_OWNER)
  status                  UserStatus               @default(ACTIVE)
  plan                    PlanTier                 @default(FREE)
  createdAt               DateTime                 @default(now()) @map("created_at")
  updatedAt               DateTime                 @default(now()) @updatedAt @map("updated_at")
  locale                  String                   @default("he")
  roles                   UserRole[]               @default([ROLE_WEDDING_OWNER])
  password                String?
  stripeCurrentPeriodEnd  DateTime?                @map("stripe_current_period_end")
  stripeCustomerId        String?                  @unique @map("stripe_customer_id")
  stripePriceId           String?                  @map("stripe_price_id")
  stripeSubscriptionId    String?                  @unique @map("stripe_subscription_id")
  pendingPlanChange       PlanTier?                @map("pending_plan_change")
  pendingPlanChangeDate   DateTime?                @map("pending_plan_change_date")
  vapiPhoneNumberId       String?                  @map("vapi_phone_number_id")
  whatsappPhoneNumberId   String?                  @map("whatsapp_phone_number_id")
  // Workspace & Business Plan fields
  giftSystemEnabled       Boolean                  @default(true) @map("gift_system_enabled")
  voiceCallsAddOn         Boolean                  @default(false) @map("voice_calls_add_on")
  accounts                Account[]
  bulkMessageJobs         BulkMessageJob[]
  costLogs                CostLog[]
  emailVerificationTokens EmailVerificationToken[]
  passwordResetTokens     PasswordResetToken[]
  rsvpTemplates           RsvpTemplate[]
  sessions                Session[]
  usageTracking           UsageTracking?
  vapiCallJobs            VapiCallJob[]
  vapiPhoneNumber         VapiPhoneNumber?         @relation(fields: [vapiPhoneNumberId], references: [id], onDelete: SetNull)
  whatsappPhoneNumber     WhatsAppPhoneNumber?     @relation(fields: [whatsappPhoneNumberId], references: [id], onDelete: SetNull)
  weddingEvents           WeddingEvent[]
  workspaces              Workspace[]
  // Collaboration relations
  collaborations          EventCollaborator[]      @relation("CollaboratorUser")
  sentCollaboratorInvites EventCollaborator[]      @relation("InviterUser")
  eventInvitations        EventInvitation[]
  // Call center relations
  manualCallLogs          ManualCallLog[]

  @@index([vapiPhoneNumberId])
  @@index([whatsappPhoneNumberId])
  @@map("users")
}

model UsageTracking {
  id              String    @id @default(cuid())
  userId          String    @unique @map("user_id")
  whatsappSent    Int       @default(0) @map("whatsapp_sent")
  smsSent         Int       @default(0) @map("sms_sent")
  whatsappBonus   Int       @default(0) @map("whatsapp_bonus")
  smsBonus        Int       @default(0) @map("sms_bonus")
  periodStart     DateTime  @default(now()) @map("period_start")
  periodEnd       DateTime? @map("period_end")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @default(now()) @updatedAt @map("updated_at")
  voiceCallsBonus Int       @default(0) @map("voice_calls_bonus")
  voiceCallsMade  Int       @default(0) @map("voice_calls_made")

  // Cost tracking (USD)
  whatsappCost   Decimal @default(0) @map("whatsapp_cost") @db.Decimal(10, 4)
  smsCost        Decimal @default(0) @map("sms_cost") @db.Decimal(10, 4)
  voiceCallsCost Decimal @default(0) @map("voice_calls_cost") @db.Decimal(10, 4)
  totalCost      Decimal @default(0) @map("total_cost") @db.Decimal(10, 4)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("usage_tracking")
}

// ============================================
// COST TRACKING LOG (Audit Trail)
// ============================================

model CostLog {
  id             String  @id @default(cuid())
  userId         String  @map("user_id")
  weddingEventId String? @map("wedding_event_id")
  guestId        String? @map("guest_id")

  // Transaction details
  service   String // "whatsapp", "sms", "voice"
  provider  String // "twilio", "upsend", "vapi"
  quantity  Int // Message count or call duration in seconds
  unitCost  Decimal @map("unit_cost") @db.Decimal(10, 4) // Cost per unit
  totalCost Decimal @map("total_cost") @db.Decimal(10, 4) // Total cost for this transaction

  // Metadata
  metadata  Json? // Additional details (message SID, call ID, etc.)
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  weddingEvent WeddingEvent? @relation(fields: [weddingEventId], references: [id], onDelete: Cascade)
  guest        Guest?        @relation(fields: [guestId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([weddingEventId])
  @@index([service])
  @@index([createdAt])
  @@map("cost_logs")
}

// ============================================
// WORKSPACE MODEL
// ============================================

model Workspace {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  ownerId   String   @map("owner_id")
  isDefault Boolean  @default(false) @map("is_default")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  owner  User           @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  events WeddingEvent[]

  @@index([ownerId])
  @@index([slug])
  @@map("workspaces")
}

model WeddingEvent {
  id                      String                @id @default(cuid())
  ownerId                 String                @map("owner_id")
  workspaceId             String?               @map("workspace_id")
  title                   String
  description             String?
  dateTime                DateTime              @map("date_time")
  location                String
  venue                   String?
  notes                   String?
  imageUrl                String?               @map("image_url")
  isActive                Boolean               @default(true) @map("is_active")
  isArchived              Boolean               @default(false) @map("is_archived")
  archivedAt              DateTime?             @map("archived_at")
  createdAt               DateTime              @default(now()) @map("created_at")
  updatedAt               DateTime              @default(now()) @updatedAt @map("updated_at")
  smsSenderId             String?               @map("sms_sender_id")
  invitationImagePublicId String?               @map("invitation_image_public_id")
  invitationImageUrl      String?               @map("invitation_image_url")
  totalBudget             Decimal?              @map("total_budget") @db.Decimal(10, 2)
  navigationCode          String?               @unique @map("navigation_code") // Short code for navigation links (e.g., /n/abc123)
  // Custom system automation messages (overrides defaults if set)
  rsvpConfirmedMessage    String?               @map("rsvp_confirmed_message")
  rsvpDeclinedMessage     String?               @map("rsvp_declined_message")
  rsvpMaybeMessage        String?               @map("rsvp_maybe_message")
  rsvpMaybeReminderDelay  Int                   @default(24) @map("rsvp_maybe_reminder_delay") // Hours until follow-up reminder
  // Seating canvas dimensions
  seatingCanvasWidth      Int                   @default(1200) @map("seating_canvas_width")
  seatingCanvasHeight     Int                   @default(800) @map("seating_canvas_height")
  bulkMessageJobs         BulkMessageJob[]
  costLogs                CostLog[]
  guests                  Guest[]
  messageTemplates        MessageTemplate[]
  rsvpPageSettings        RsvpPageSettings?
  suppliers               Supplier[]
  vapiSettings            VapiEventSettings?
  venueBlocks             VenueBlock[]
  owner                   User                  @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  workspace               Workspace?            @relation(fields: [workspaceId], references: [id], onDelete: SetNull)
  tables                  WeddingTable[]
  tasks                   WeddingTask[]
  // New module relations
  automationFlows         AutomationFlow[]
  generatedInvitations    GeneratedInvitation[]
  giftPaymentSettings     GiftPaymentSettings?
  giftPayments            GiftPayment[]
  manualCallLogs          ManualCallLog[]
  transportationRegistrations TransportationRegistration[]
  transportationPickupPlaces  TransportationPickupPlace[]
  smsTemplates            EventSmsTemplate[]
  // Collaboration relations
  collaborators           EventCollaborator[]
  invitations             EventInvitation[]

  @@index([ownerId])
  @@index([workspaceId])
  @@index([isArchived])
  @@map("wedding_events")
}

model EventCollaborator {
  id         String           @id @default(cuid())
  eventId    String           @map("event_id")
  userId     String           @map("user_id")
  role       CollaboratorRole @default(EDITOR)
  invitedBy  String           @map("invited_by")
  acceptedAt DateTime?        @map("accepted_at")
  createdAt  DateTime         @default(now()) @map("created_at")

  event   WeddingEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user    User         @relation("CollaboratorUser", fields: [userId], references: [id], onDelete: Cascade)
  inviter User         @relation("InviterUser", fields: [invitedBy], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
  @@index([eventId])
  @@index([userId])
  @@map("event_collaborators")
}

model EventInvitation {
  id         String           @id @default(cuid())
  eventId    String           @map("event_id")
  email      String? // Optional - for email invites
  token      String           @unique
  role       CollaboratorRole @default(EDITOR)
  invitedBy  String           @map("invited_by")
  expiresAt  DateTime         @map("expires_at")
  acceptedAt DateTime?        @map("accepted_at")
  createdAt  DateTime         @default(now()) @map("created_at")

  event   WeddingEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  inviter User         @relation(fields: [invitedBy], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@index([token])
  @@map("event_invitations")
}

model Guest {
  id                      String                    @id @default(cuid())
  weddingEventId          String                    @map("wedding_event_id")
  name                    String
  phoneNumber             String?                   @map("phone_number")
  email                   String?
  slug                    String                    @unique
  transportationSlug      String?                   @unique @map("transportation_slug")
  side                    String?
  groupName               String?                   @map("group_name")
  notes                   String?
  createdAt               DateTime                  @default(now()) @map("created_at")
  updatedAt               DateTime                  @default(now()) @updatedAt @map("updated_at")
  expectedGuests          Int                       @default(1) @map("expected_guests")
  // Arrival tracking for hostess page
  arrivedAt               DateTime?                 @map("arrived_at")
  arrivedTableId          String?                   @map("arrived_table_id")
  bulkMessageJobItems     BulkMessageJobItem[]
  costLogs                CostLog[]
  rsvp                    GuestRsvp?
  weddingEvent            WeddingEvent              @relation(fields: [weddingEventId], references: [id], onDelete: Cascade)
  notificationLogs        NotificationLog[]
  tableAssignment         TableAssignment?
  seatAssignment          TableSeat? // NEW RELATION for seat-level assignment
  vapiCallLogs            VapiCallLog[]
  whatsappResponses       WhatsAppButtonResponse[]
  // New module relations
  automationExecutions    AutomationFlowExecution[]
  giftPayments            GiftPayment[]
  manualCallLogs          ManualCallLog[]
  transportationRegistration TransportationRegistration?

  @@index([weddingEventId])
  @@index([slug])
  @@index([transportationSlug])
  @@map("guests")
}

model GuestRsvp {
  id          String     @id @default(cuid())
  guestId     String     @unique @map("guest_id")
  status      RsvpStatus @default(PENDING)
  guestCount  Int        @default(1) @map("guest_count")
  note        String?
  respondedAt DateTime?  @map("responded_at")
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @default(now()) @updatedAt @map("updated_at")
  guest       Guest      @relation(fields: [guestId], references: [id], onDelete: Cascade)

  @@index([status])
  @@map("guest_rsvps")
}

model TransportationPickupPlace {
  id             String                      @id @default(cuid())
  weddingEventId String                      @map("wedding_event_id")
  name           String // Pickup place name (e.g., "Tel Aviv Central Station")
  nameHe         String?                     @map("name_he") // Hebrew name
  nameEn         String?                     @map("name_en") // English name
  nameAr         String?                     @map("name_ar") // Arabic name
  address        String? // Full address (optional)
  notes          String? // Internal notes for event owner
  sortOrder      Int                         @default(0) @map("sort_order") // Display order
  isActive       Boolean                     @default(true) @map("is_active") // Can be disabled without deletion
  createdAt      DateTime                    @default(now()) @map("created_at")
  updatedAt      DateTime                    @default(now()) @updatedAt @map("updated_at")

  weddingEvent   WeddingEvent                @relation(fields: [weddingEventId], references: [id], onDelete: Cascade)
  registrations  TransportationRegistration[]

  @@index([weddingEventId])
  @@index([isActive])
  @@map("transportation_pickup_places")
}

model TransportationRegistration {
  id              String                      @id @default(cuid())
  weddingEventId  String                      @map("wedding_event_id")
  guestId         String?                     @unique @map("guest_id") // Optional - allows generic registrations
  pickupPlaceId   String?                     @map("pickup_place_id") // Selected pickup place (if using predefined places)
  fullName        String                      @map("full_name")
  phoneNumber     String                      @map("phone_number")
  location        String // Pickup location/address (used if pickupPlaceId is null, or for custom location)
  language        String                      @default("he") // Registration language: "he", "en", "ar"
  notes           String? // Optional notes from guest
  registeredAt    DateTime                    @default(now()) @map("registered_at")
  createdAt       DateTime                    @default(now()) @map("created_at")
  updatedAt       DateTime                    @default(now()) @updatedAt @map("updated_at")

  weddingEvent    WeddingEvent                @relation(fields: [weddingEventId], references: [id], onDelete: Cascade)
  guest           Guest?                      @relation(fields: [guestId], references: [id], onDelete: Cascade)
  pickupPlace     TransportationPickupPlace?  @relation(fields: [pickupPlaceId], references: [id], onDelete: SetNull)

  @@index([weddingEventId])
  @@index([guestId])
  @@index([pickupPlaceId])
  @@map("transportation_registrations")
}

model NotificationLog {
  id               String              @id @default(cuid())
  guestId          String              @map("guest_id")
  type             NotificationType
  channel          NotificationChannel
  status           NotificationStatus  @default(PENDING)
  providerResponse String?             @map("provider_response")
  sentAt           DateTime?           @map("sent_at")
  deliveredAt      DateTime?           @map("delivered_at")
  createdAt        DateTime            @default(now()) @map("created_at")
  // Delivery status tracking fields
  errorCode        Int?                @map("error_code")
  errorMessage     String?             @map("error_message")
  twilioStatus     String?             @map("twilio_status")
  guest            Guest               @relation(fields: [guestId], references: [id], onDelete: Cascade)

  @@index([guestId])
  @@index([type, status])
  @@index([guestId, createdAt])
  @@index([status, channel])
  @@map("notification_logs")
}

model RsvpPageSettings {
  id                           String           @id @default(cuid())
  weddingEventId               String           @unique @map("wedding_event_id")
  backgroundType               BackgroundType   @default(IMAGE) @map("background_type")
  backgroundColor              String?          @map("background_color")
  backgroundImage              String?          @map("background_image")
  backgroundOverlay            Float?           @map("background_overlay")
  primaryColor                 String?          @map("primary_color")
  secondaryColor               String?          @map("secondary_color")
  textColor                    String?          @map("text_color")
  fontFamily                   String?          @map("font_family")
  cardStyle                    CardStyle        @default(GLASS) @map("card_style")
  cardBackground               String?          @map("card_background")
  cardBorderRadius             Int?             @map("card_border_radius")
  welcomeTitle                 String?          @map("welcome_title")
  welcomeMessage               String?          @map("welcome_message")
  thankYouMessage              String?          @map("thank_you_message")
  createdAt                    DateTime         @default(now()) @map("created_at")
  updatedAt                    DateTime         @default(now()) @updatedAt @map("updated_at")
  accentColor                  String?          @map("accent_color")
  backgroundBlur               Int?             @map("background_blur")
  buttonBorderRadius           Int?             @map("button_border_radius")
  buttonColor                  String?          @map("button_color")
  buttonStyle                  String?          @map("button_style")
  buttonTextColor              String?          @map("button_text_color")
  cardMaxWidth                 Int?             @map("card_max_width")
  cardOpacity                  Float?           @map("card_opacity")
  cardPadding                  Int?             @map("card_padding")
  declineMessage               String?          @map("decline_message")
  showGoogleMaps               Boolean          @default(true) @map("show_google_maps")
  cardBlur                     Int?             @map("card_blur")
  pageLocale                   String           @default("he") @map("page_locale")
  googleMapsUrl                String?          @map("google_maps_url")
  showWaze                     Boolean          @default(true) @map("show_waze")
  wazeUrl                      String?          @map("waze_url")
  inputBackgroundColor         String?          @map("input_background_color")
  inputBorderColor             String?          @map("input_border_color")
  inputTextColor               String?          @map("input_text_color")
  labelTextColor               String?          @map("label_text_color")
  subtitleTextColor            String?          @map("subtitle_text_color")
  buttonBorderColor            String?          @map("button_border_color")
  buttonShadow                 Boolean          @default(true) @map("button_shadow")
  buttonSize                   String?          @map("button_size")
  dateCardAccentColor          String?          @map("date_card_accent_color")
  dateCardBackground           String?          @map("date_card_background")
  dateCardBorderRadius         Int?             @map("date_card_border_radius")
  dateCardTextColor            String?          @map("date_card_text_color")
  dateDisplayStyle             DateDisplayStyle @default(CALENDAR) @map("date_display_style")
  showCountdown                Boolean          @default(true) @map("show_countdown")
  guestCounterAccent           String?          @map("guest_counter_accent")
  guestCounterBackground       String?          @map("guest_counter_background")
  guestCounterTextColor        String?          @map("guest_counter_text_color")
  buttonFontSize               Int?             @map("button_font_size")
  labelFontSize                Int?             @map("label_font_size")
  subtitleFontSize             Int?             @map("subtitle_font_size")
  titleFontSize                Int?             @map("title_font_size")
  acceptButtonColor            String?          @map("accept_button_color")
  acceptButtonTextColor        String?          @map("accept_button_text_color")
  addressFontSize              Int?             @map("address_font_size")
  addressSectionBackground     String?          @map("address_section_background")
  addressSectionBorderRadius   Int?             @map("address_section_border_radius")
  addressSectionTextColor      String?          @map("address_section_text_color")
  countdownBoxBackground       String?          @map("countdown_box_background")
  countdownBoxTextColor        String?          @map("countdown_box_text_color")
  countdownLabelColor          String?          @map("countdown_label_color")
  countdownNumberFontSize      Int?             @map("countdown_number_font_size")
  countdownSectionBackground   String?          @map("countdown_section_background")
  countdownSectionBorderRadius Int?             @map("countdown_section_border_radius")
  countdownSectionTextColor    String?          @map("countdown_section_text_color")
  dateCardBackgroundImage      String?          @map("date_card_background_image")
  dateCardBlur                 Int?             @map("date_card_blur")
  dateCardOverlay              Float?           @map("date_card_overlay")
  dateCardPadding              Int?             @map("date_card_padding")
  dateCardShadow               Boolean          @default(true) @map("date_card_shadow")
  dateDayFontSize              Int?             @map("date_day_font_size")
  dateMonthFontSize            Int?             @map("date_month_font_size")
  dateYearFontSize             Int?             @map("date_year_font_size")
  declineButtonColor           String?          @map("decline_button_color")
  declineButtonTextColor       String?          @map("decline_button_text_color")
  questionFontSize             Int?             @map("question_font_size")
  questionSectionBackground    String?          @map("question_section_background")
  questionSectionBorderRadius  Int?             @map("question_section_border_radius")
  questionTextColor            String?          @map("question_text_color")
  showAddressSection           Boolean          @default(true) @map("show_address_section")
  showTimeSection              Boolean          @default(true) @map("show_time_section")
  timeFontSize                 Int?             @map("time_font_size")
  timeSectionBackground        String?          @map("time_section_background")
  timeSectionBorderRadius      Int?             @map("time_section_border_radius")
  timeSectionTextColor         String?          @map("time_section_text_color")
  advancedMode                 Boolean          @default(false) @map("advanced_mode")
  cardBorderColor              String?          @map("card_border_color")
  cardBorderWidth              Int?             @map("card_border_width")
  cardShadow                   Boolean          @default(true) @map("card_shadow")
  addressIconColor             String?          @map("address_icon_color")
  countdownLabelFontSize       Int?             @map("countdown_label_font_size")
  dateDayNumberColor           String?          @map("date_day_number_color")
  dateDayOfWeekColor           String?          @map("date_day_of_week_color")
  dateDayOfWeekFontSize        Int?             @map("date_day_of_week_font_size")
  dateMonthYearColor           String?          @map("date_month_year_color")
  timeIconColor                String?          @map("time_icon_color")
  welcomeMessageColor          String?          @map("welcome_message_color")
  welcomeMessageFontSize       Int?             @map("welcome_message_font_size")
  welcomeTitleColor            String?          @map("welcome_title_color")
  welcomeTitleFontSize         Int?             @map("welcome_title_font_size")
  guestCounterButtonColor      String?          @map("guest_counter_button_color")
  rsvpAcceptBackground         String?          @map("rsvp_accept_background")
  rsvpAcceptTextColor          String?          @map("rsvp_accept_text_color")
  rsvpDeclineBackground        String?          @map("rsvp_decline_background")
  rsvpDeclineTextColor         String?          @map("rsvp_decline_text_color")
  titleTextColor               String?          @map("title_text_color")
  rsvpButtonFontSize           Int?             @map("rsvp_button_font_size")
  showBuiltByGroom             Boolean          @default(false) @map("show_built_by_groom")
  // Font Weights
  titleFontWeight              Int?             @map("title_font_weight")
  subtitleFontWeight           Int?             @map("subtitle_font_weight")
  labelFontWeight              Int?             @map("label_font_weight")
  buttonTextFontWeight         Int?             @map("button_text_font_weight")
  dateDayFontWeight            Int?             @map("date_day_font_weight")
  dateMonthFontWeight          Int?             @map("date_month_font_weight")
  dateDayOfWeekFontWeight      Int?             @map("date_day_of_week_font_weight")
  countdownNumberFontWeight    Int?             @map("countdown_number_font_weight")
  countdownLabelFontWeight     Int?             @map("countdown_label_font_weight")
  timeFontWeight               Int?             @map("time_font_weight")
  addressFontWeight            Int?             @map("address_font_weight")
  // Navigation Button Styling
  navButtonFontSize            Int?             @map("nav_button_font_size")
  navButtonFontWeight          Int?             @map("nav_button_font_weight")
  navButtonBackground          String?          @map("nav_button_background")
  navButtonTextColor           String?          @map("nav_button_text_color")
  navButtonBorderColor         String?          @map("nav_button_border_color")
  navButtonBorderRadius        Int?             @map("nav_button_border_radius")
  navButtonBorderWidth         Int?             @map("nav_button_border_width")
  weddingEvent                 WeddingEvent     @relation(fields: [weddingEventId], references: [id], onDelete: Cascade)

  @@map("rsvp_page_settings")
}

model RsvpTemplate {
  id                           String           @id @default(cuid())
  name                         String
  description                  String?
  previewUrl                   String?          @map("preview_url")
  isSystem                     Boolean          @default(false) @map("is_system")
  ownerId                      String?          @map("owner_id")
  backgroundType               BackgroundType   @default(IMAGE) @map("background_type")
  backgroundColor              String?          @map("background_color")
  backgroundImage              String?          @map("background_image")
  backgroundOverlay            Float?           @map("background_overlay")
  backgroundBlur               Int?             @map("background_blur")
  primaryColor                 String?          @map("primary_color")
  secondaryColor               String?          @map("secondary_color")
  textColor                    String?          @map("text_color")
  accentColor                  String?          @map("accent_color")
  fontFamily                   String?          @map("font_family")
  cardStyle                    CardStyle        @default(GLASS) @map("card_style")
  cardBackground               String?          @map("card_background")
  cardBorderRadius             Int?             @map("card_border_radius")
  cardPadding                  Int?             @map("card_padding")
  cardMaxWidth                 Int?             @map("card_max_width")
  cardOpacity                  Float?           @map("card_opacity")
  showGoogleMaps               Boolean          @default(true) @map("show_google_maps")
  welcomeTitle                 String?          @map("welcome_title")
  welcomeMessage               String?          @map("welcome_message")
  thankYouMessage              String?          @map("thank_you_message")
  declineMessage               String?          @map("decline_message")
  buttonStyle                  String?          @map("button_style")
  buttonColor                  String?          @map("button_color")
  buttonTextColor              String?          @map("button_text_color")
  buttonBorderRadius           Int?             @map("button_border_radius")
  createdAt                    DateTime         @default(now()) @map("created_at")
  updatedAt                    DateTime         @default(now()) @updatedAt @map("updated_at")
  cardBlur                     Int?             @map("card_blur")
  pageLocale                   String           @default("he") @map("page_locale")
  showWaze                     Boolean          @default(true) @map("show_waze")
  inputBackgroundColor         String?          @map("input_background_color")
  inputBorderColor             String?          @map("input_border_color")
  inputTextColor               String?          @map("input_text_color")
  labelTextColor               String?          @map("label_text_color")
  subtitleTextColor            String?          @map("subtitle_text_color")
  buttonBorderColor            String?          @map("button_border_color")
  buttonShadow                 Boolean          @default(true) @map("button_shadow")
  buttonSize                   String?          @map("button_size")
  dateCardAccentColor          String?          @map("date_card_accent_color")
  dateCardBackground           String?          @map("date_card_background")
  dateCardBorderRadius         Int?             @map("date_card_border_radius")
  dateCardTextColor            String?          @map("date_card_text_color")
  dateDisplayStyle             DateDisplayStyle @default(CALENDAR) @map("date_display_style")
  showCountdown                Boolean          @default(true) @map("show_countdown")
  guestCounterAccent           String?          @map("guest_counter_accent")
  guestCounterBackground       String?          @map("guest_counter_background")
  guestCounterTextColor        String?          @map("guest_counter_text_color")
  buttonFontSize               Int?             @map("button_font_size")
  labelFontSize                Int?             @map("label_font_size")
  subtitleFontSize             Int?             @map("subtitle_font_size")
  titleFontSize                Int?             @map("title_font_size")
  acceptButtonColor            String?          @map("accept_button_color")
  acceptButtonTextColor        String?          @map("accept_button_text_color")
  addressFontSize              Int?             @map("address_font_size")
  addressSectionBackground     String?          @map("address_section_background")
  addressSectionBorderRadius   Int?             @map("address_section_border_radius")
  addressSectionTextColor      String?          @map("address_section_text_color")
  countdownBoxBackground       String?          @map("countdown_box_background")
  countdownBoxTextColor        String?          @map("countdown_box_text_color")
  countdownLabelColor          String?          @map("countdown_label_color")
  countdownNumberFontSize      Int?             @map("countdown_number_font_size")
  countdownSectionBackground   String?          @map("countdown_section_background")
  countdownSectionBorderRadius Int?             @map("countdown_section_border_radius")
  countdownSectionTextColor    String?          @map("countdown_section_text_color")
  dateCardBackgroundImage      String?          @map("date_card_background_image")
  dateCardBlur                 Int?             @map("date_card_blur")
  dateCardOverlay              Float?           @map("date_card_overlay")
  dateCardPadding              Int?             @map("date_card_padding")
  dateCardShadow               Boolean          @default(true) @map("date_card_shadow")
  dateDayFontSize              Int?             @map("date_day_font_size")
  dateMonthFontSize            Int?             @map("date_month_font_size")
  dateYearFontSize             Int?             @map("date_year_font_size")
  declineButtonColor           String?          @map("decline_button_color")
  declineButtonTextColor       String?          @map("decline_button_text_color")
  questionFontSize             Int?             @map("question_font_size")
  questionSectionBackground    String?          @map("question_section_background")
  questionSectionBorderRadius  Int?             @map("question_section_border_radius")
  questionTextColor            String?          @map("question_text_color")
  showAddressSection           Boolean          @default(true) @map("show_address_section")
  showTimeSection              Boolean          @default(true) @map("show_time_section")
  timeFontSize                 Int?             @map("time_font_size")
  timeSectionBackground        String?          @map("time_section_background")
  timeSectionBorderRadius      Int?             @map("time_section_border_radius")
  timeSectionTextColor         String?          @map("time_section_text_color")
  advancedMode                 Boolean          @default(false) @map("advanced_mode")
  cardBorderColor              String?          @map("card_border_color")
  cardBorderWidth              Int?             @map("card_border_width")
  cardShadow                   Boolean          @default(true) @map("card_shadow")
  addressIconColor             String?          @map("address_icon_color")
  countdownLabelFontSize       Int?             @map("countdown_label_font_size")
  dateDayNumberColor           String?          @map("date_day_number_color")
  dateDayOfWeekColor           String?          @map("date_day_of_week_color")
  dateDayOfWeekFontSize        Int?             @map("date_day_of_week_font_size")
  dateMonthYearColor           String?          @map("date_month_year_color")
  timeIconColor                String?          @map("time_icon_color")
  welcomeMessageColor          String?          @map("welcome_message_color")
  welcomeMessageFontSize       Int?             @map("welcome_message_font_size")
  welcomeTitleColor            String?          @map("welcome_title_color")
  welcomeTitleFontSize         Int?             @map("welcome_title_font_size")
  // Font Weights
  titleFontWeight              Int?             @map("title_font_weight")
  subtitleFontWeight           Int?             @map("subtitle_font_weight")
  labelFontWeight              Int?             @map("label_font_weight")
  buttonTextFontWeight         Int?             @map("button_text_font_weight")
  dateDayFontWeight            Int?             @map("date_day_font_weight")
  dateMonthFontWeight          Int?             @map("date_month_font_weight")
  dateDayOfWeekFontWeight      Int?             @map("date_day_of_week_font_weight")
  countdownNumberFontWeight    Int?             @map("countdown_number_font_weight")
  countdownLabelFontWeight     Int?             @map("countdown_label_font_weight")
  timeFontWeight               Int?             @map("time_font_weight")
  addressFontWeight            Int?             @map("address_font_weight")
  // Navigation Button Styling
  navButtonFontSize            Int?             @map("nav_button_font_size")
  navButtonFontWeight          Int?             @map("nav_button_font_weight")
  navButtonBackground          String?          @map("nav_button_background")
  navButtonTextColor           String?          @map("nav_button_text_color")
  navButtonBorderColor         String?          @map("nav_button_border_color")
  navButtonBorderRadius        Int?             @map("nav_button_border_radius")
  navButtonBorderWidth         Int?             @map("nav_button_border_width")
  owner                        User?            @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  @@index([ownerId])
  @@index([isSystem])
  @@map("rsvp_templates")
}

model MessagingProviderSettings {
  id                               String   @id @default(cuid())
  whatsappProvider                 String?  @map("whatsapp_provider")
  whatsappApiKey                   String?  @map("whatsapp_api_key")
  whatsappApiSecret                String?  @map("whatsapp_api_secret")
  whatsappPhoneNumber              String?  @map("whatsapp_phone_number")
  whatsappEnabled                  Boolean  @default(false) @map("whatsapp_enabled")
  smsProvider                      String?  @map("sms_provider")
  smsApiKey                        String?  @map("sms_api_key")
  smsApiSecret                     String?  @map("sms_api_secret")
  smsPhoneNumber                   String?  @map("sms_phone_number")
  smsEnabled                       Boolean  @default(false) @map("sms_enabled")
  createdAt                        DateTime @default(now()) @map("created_at")
  updatedAt                        DateTime @default(now()) @updatedAt @map("updated_at")
  smsMessagingServiceSid           String?  @map("sms_messaging_service_sid")
  whatsappConfirmationContentSid   String?  @map("whatsapp_confirmation_content_sid")
  whatsappInviteContentSid         String?  @map("whatsapp_invite_content_sid")
  whatsappReminderContentSid       String?  @map("whatsapp_reminder_content_sid")
  whatsappConfirmationTemplateText String?  @map("whatsapp_confirmation_template_text")
  whatsappInviteTemplateText       String?  @map("whatsapp_invite_template_text")
  whatsappReminderTemplateText     String?  @map("whatsapp_reminder_template_text")
  whatsappImageInviteContentSid    String?  @map("whatsapp_image_invite_content_sid")
  azureSpeechKey                   String?  @map("azure_speech_key")
  azureSpeechRegion                String?  @map("azure_speech_region")
  vapiApiKey                       String?  @map("vapi_api_key")
  vapiAssistantId                  String?  @map("vapi_assistant_id")
  vapiDefaultVoiceId               String?  @default("he-IL-AvriNeural") @map("vapi_default_voice_id")
  vapiEnabled                      Boolean  @default(false) @map("vapi_enabled")
  vapiPhoneNumber                  String?  @map("vapi_phone_number")
  vapiPhoneNumberId                String?  @map("vapi_phone_number_id")
  vapiWebhookSecret                String?  @map("vapi_webhook_secret")

  // Interactive Button Templates
  whatsappInteractiveInviteContentSid   String? @map("whatsapp_interactive_invite_content_sid")
  whatsappInteractiveReminderContentSid String? @map("whatsapp_interactive_reminder_content_sid")
  whatsappGuestCountListContentSid      String? @map("whatsapp_guest_count_list_content_sid")

  // Interactive template text for display
  whatsappInteractiveInviteText   String? @map("whatsapp_interactive_invite_text")
  whatsappInteractiveReminderText String? @map("whatsapp_interactive_reminder_text")

  // Event Day Templates (morning of event with table, address, gift link)
  whatsappEventDayContentSid   String? @map("whatsapp_event_day_content_sid")
  whatsappEventDayTemplateText String? @map("whatsapp_event_day_template_text")

  // Thank You Templates (day after event)
  whatsappThankYouContentSid   String? @map("whatsapp_thank_you_content_sid")
  whatsappThankYouTemplateText String? @map("whatsapp_thank_you_template_text")

  // Twilio Voice (Call Center) Settings
  twilioVoiceAccountSid        String?  @map("twilio_voice_account_sid")
  twilioVoiceAuthToken         String?  @map("twilio_voice_auth_token")
  twilioVoiceApiKey            String?  @map("twilio_voice_api_key")
  twilioVoiceApiSecret         String?  @map("twilio_voice_api_secret")
  twilioVoiceTwimlAppSid       String?  @map("twilio_voice_twiml_app_sid")
  twilioVoicePhoneNumber       String?  @map("twilio_voice_phone_number")
  twilioVoiceEnabled           Boolean  @default(false) @map("twilio_voice_enabled")

  // Related phone numbers
  whatsappPhoneNumbers WhatsAppPhoneNumber[]

  @@map("messaging_provider_settings")
}

model MessageTemplate {
  id                String           @id @default(cuid())
  weddingEventId    String           @map("wedding_event_id")
  type              NotificationType
  locale            String           @default("he")
  title             String
  message           String
  isAcceptedVariant Boolean          @default(false) @map("is_accepted_variant")
  isActive          Boolean          @default(true) @map("is_active")
  createdAt         DateTime         @default(now()) @map("created_at")
  updatedAt         DateTime         @default(now()) @updatedAt @map("updated_at")
  weddingEvent      WeddingEvent     @relation(fields: [weddingEventId], references: [id], onDelete: Cascade)

  @@unique([weddingEventId, type, locale, isAcceptedVariant])
  @@index([weddingEventId])
  @@map("message_templates")
}

// WhatsApp templates approved in Twilio dashboard
// Supports multiple templates per type (e.g., formal, friendly, short)
model WhatsAppTemplate {
  id                String                      @id @default(cuid())
  type              WhatsAppTemplateType
  style             String // "style1", "style2", "style3"
  nameHe            String                      @map("name_he")
  nameEn            String                      @map("name_en")
  contentSid        String?                     @map("content_sid") // Twilio Content SID (null until approved)
  templateText      String?                     @map("template_text") // For display/reference
  previewText       String?                     @map("preview_text") // Preview text in English for send dialog
  previewTextHe     String?                     @map("preview_text_he") // Preview text in Hebrew for send dialog
  isActive          Boolean                     @default(true) @map("is_active")
  sortOrder         Int                         @default(0) @map("sort_order")

  // Template creation and approval tracking
  approvalStatus    WhatsAppTemplateApprovalStatus @default(DRAFT) @map("approval_status")
  twilioTemplateName String?                    @map("twilio_template_name") // Suggested/actual Twilio template name
  templateBodyHe    String?                     @map("template_body_he") @db.Text // Hebrew template body text
  templateBodyEn    String?                     @map("template_body_en") @db.Text // English template body text
  variables         Json?                       // Variable definitions: {1: "Guest Name", 2: "Event Title", etc.}
  buttonsConfig     Json?                       @map("buttons_config") // Button configuration for interactive templates
  rejectionReason   String?                     @map("rejection_reason") @db.Text // Reason for rejection (if rejected)
  submittedAt       DateTime?                   @map("submitted_at") // When submitted to Twilio
  approvedAt        DateTime?                   @map("approved_at") // When approved by WhatsApp

  // Twilio Content API fields
  contentType       String?                     @map("content_type") // twilio/text, twilio/quick-reply, twilio/media, etc.
  category          String?                     @default("UTILITY") // UTILITY, MARKETING, AUTHENTICATION
  language          String?                     @default("he") // Language code (he, en, en_US, he_IL)
  headerText        String?                     @map("header_text") // Optional header text
  footerText        String?                     @map("footer_text") // Optional footer text
  mediaType         String?                     @map("media_type") // IMAGE, VIDEO, DOCUMENT (for media templates)

  createdAt         DateTime                    @default(now()) @map("created_at")
  updatedAt         DateTime                    @default(now()) @updatedAt @map("updated_at")

  @@unique([type, style])
  @@index([type, isActive])
  @@index([approvalStatus])
  @@map("whatsapp_templates")
}

// Event-scoped SMS templates (user-created)
model EventSmsTemplate {
  id             String              @id @default(cuid())
  weddingEventId String              @map("wedding_event_id")
  type           SmsTemplateType     // INVITE, REMINDER, EVENT_DAY, THANK_YOU
  style          String              // "style1" (Normal), "style2" (Informative), "style3" (Transportation)
  nameHe         String              @map("name_he") // Display name in Hebrew
  nameEn         String              @map("name_en") // Display name in English
  messageBodyHe  String              @map("message_body_he") @db.Text // SMS body in Hebrew (with {{1}}-{{12}} variables)
  messageBodyEn  String?             @map("message_body_en") @db.Text // SMS body in English (optional)
  variables      Json?               // Variable definitions: {1: "Guest Name", 2: "Event Title", etc.}
  isActive       Boolean             @default(true) @map("is_active")
  isDefault      Boolean             @default(false) @map("is_default") // System default templates
  sortOrder      Int                 @default(0) @map("sort_order")
  createdAt      DateTime            @default(now()) @map("created_at")
  updatedAt      DateTime            @default(now()) @updatedAt @map("updated_at")

  weddingEvent   WeddingEvent        @relation(fields: [weddingEventId], references: [id], onDelete: Cascade)

  @@unique([weddingEventId, type, style])
  @@index([weddingEventId, isActive])
  @@index([type])
  @@map("event_sms_templates")
}

enum SmsTemplateType {
  INVITE      // Standard invite with RSVP link
  REMINDER    // Standard reminder with RSVP link
  EVENT_DAY   // Event day reminder (morning of event)
  THANK_YOU   // Thank you message (day after event - aka DAY_AFTER_EVENT)
}

enum WhatsAppTemplateApprovalStatus {
  DRAFT          // Created in admin but not submitted to Twilio yet
  PENDING        // Submitted to Twilio, awaiting WhatsApp approval
  APPROVED       // Approved by WhatsApp and ready to use
  REJECTED       // Rejected by WhatsApp
  PAUSED         // Temporarily paused/disabled
}

enum WhatsAppTemplateType {
  INVITE // Standard invite with RSVP link
  REMINDER // Standard reminder with RSVP link
  INTERACTIVE_INVITE // Interactive buttons invite
  INTERACTIVE_REMINDER // Interactive buttons reminder
  IMAGE_INVITE // Image invite with invitation image
  TRANSPORTATION_INVITE // Formal invite with RSVP link + Transportation link
  CONFIRMATION // RSVP confirmation message
  EVENT_DAY // Event day reminder (morning of event)
  THANK_YOU // Thank you message (day after event)
  TABLE_ASSIGNMENT // Table assignment notification
  GUEST_COUNT_LIST // @deprecated - Guest count list picker (kept for backward compatibility)
}

model BulkMessageJob {
  id             String               @id @default(cuid())
  weddingEventId String               @map("wedding_event_id")
  createdBy      String               @map("created_by")
  messageType    NotificationType
  channel        NotificationChannel?
  status         BulkJobStatus        @default(PENDING)
  totalGuests    Int                  @map("total_guests")
  processedCount Int                  @default(0) @map("processed_count")
  successCount   Int                  @default(0) @map("success_count")
  failedCount    Int                  @default(0) @map("failed_count")
  startedAt      DateTime?            @map("started_at")
  completedAt    DateTime?            @map("completed_at")
  createdAt      DateTime             @default(now()) @map("created_at")
  errorMessage   String?              @map("error_message")
  items          BulkMessageJobItem[]
  creator        User                 @relation(fields: [createdBy], references: [id])
  weddingEvent   WeddingEvent         @relation(fields: [weddingEventId], references: [id], onDelete: Cascade)

  @@index([weddingEventId])
  @@index([createdBy])
  @@index([status])
  @@map("bulk_message_jobs")
}

model BulkMessageJobItem {
  id           String             @id @default(cuid())
  jobId        String             @map("job_id")
  guestId      String             @map("guest_id")
  status       NotificationStatus @default(PENDING)
  attempts     Int                @default(0)
  sentAt       DateTime?          @map("sent_at")
  errorMessage String?            @map("error_message")
  guest        Guest              @relation(fields: [guestId], references: [id], onDelete: Cascade)
  job          BulkMessageJob     @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([jobId])
  @@index([guestId])
  @@index([status])
  @@index([jobId, status])
  @@map("bulk_message_job_items")
}

model WeddingTable {
  id                 String            @id @default(cuid())
  weddingEventId     String            @map("wedding_event_id")
  name               String
  capacity           Int               @default(10)
  positionX          Int?              @map("position_x")
  positionY          Int?              @map("position_y")
  shape              String?           @default("circle")
  createdAt          DateTime          @default(now()) @map("created_at")
  updatedAt          DateTime          @default(now()) @updatedAt @map("updated_at")
  height             Int               @default(100)
  width              Int               @default(100)
  rotation           Int               @default(0)
  // NEW FIELDS for seat arrangement
  seatingArrangement String?           @default("even") @map("seating_arrangement") // "even", "bride-side", "sides-only", "custom"
  colorTheme         String?           @default("default") @map("color_theme") // "default", "blue", "green", "purple", "pink", "amber", "rose"
  assignments        TableAssignment[]
  seats              TableSeat[] // NEW RELATION
  weddingEvent       WeddingEvent      @relation(fields: [weddingEventId], references: [id], onDelete: Cascade)

  @@index([weddingEventId])
  @@map("wedding_tables")
}

model TableAssignment {
  id        String       @id @default(cuid())
  tableId   String       @map("table_id")
  guestId   String       @unique @map("guest_id") // Keep @unique for backward compatibility
  createdAt DateTime     @default(now()) @map("created_at")
  guest     Guest        @relation(fields: [guestId], references: [id], onDelete: Cascade)
  table     WeddingTable @relation(fields: [tableId], references: [id], onDelete: Cascade)

  @@unique([tableId, guestId])
  @@index([tableId])
  @@index([guestId])
  @@map("table_assignments")
}

// NEW MODEL: Individual seats around a table
model TableSeat {
  id         String @id @default(cuid())
  tableId    String @map("table_id")
  seatNumber Int    @map("seat_number") // 1, 2, 3, etc.

  // Position relative to table center (for visual rendering)
  relativeX Float @default(0) @map("relative_x") // -1 to 1
  relativeY Float @default(0) @map("relative_y") // -1 to 1
  angle     Float @default(0) // Angle in degrees for rotation

  // Assignment
  guestId String? @unique @map("guest_id")
  guest   Guest?  @relation(fields: [guestId], references: [id], onDelete: SetNull)

  table     WeddingTable @relation(fields: [tableId], references: [id], onDelete: Cascade)
  createdAt DateTime     @default(now()) @map("created_at")

  @@unique([tableId, seatNumber])
  @@index([tableId])
  @@index([guestId])
  @@map("table_seats")
}

model VenueBlock {
  id             String       @id @default(cuid())
  weddingEventId String       @map("wedding_event_id")
  name           String
  type           String
  positionX      Int?         @map("position_x")
  positionY      Int?         @map("position_y")
  width          Int          @default(100)
  height         Int          @default(100)
  rotation       Int          @default(0)
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @default(now()) @updatedAt @map("updated_at")
  shape          String       @default("rectangle")
  colorTheme     String       @default("default") @map("color_theme")
  weddingEvent   WeddingEvent @relation(fields: [weddingEventId], references: [id], onDelete: Cascade)

  @@index([weddingEventId])
  @@map("venue_blocks")
}

model CronJobLog {
  id           String        @id @default(cuid())
  jobType      CronJobType   @map("job_type")
  status       CronJobStatus
  userId       String?       @map("user_id")
  userEmail    String?       @map("user_email")
  fromPlan     PlanTier?     @map("from_plan")
  toPlan       PlanTier?     @map("to_plan")
  scheduledFor DateTime?     @map("scheduled_for")
  executedAt   DateTime      @default(now()) @map("executed_at")
  message      String?
  errorDetails String?       @map("error_details")
  createdAt    DateTime      @default(now()) @map("created_at")

  @@index([jobType])
  @@index([status])
  @@index([userId])
  @@index([executedAt])
  @@map("cron_job_logs")
}

model VapiPhoneNumber {
  id          String   @id @default(cuid())
  phoneNumber String   @unique @map("phone_number")
  vapiPhoneId String   @unique @map("vapi_phone_id")
  displayName String?  @map("display_name")
  isDefault   Boolean  @default(false) @map("is_default")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at")
  users       User[]

  @@index([isDefault])
  @@index([isActive])
  @@map("vapi_phone_numbers")
}

model VapiEventSettings {
  id                 String          @id @default(cuid())
  weddingEventId     String          @unique @map("wedding_event_id")
  customSystemPrompt String?         @map("custom_system_prompt")
  customFirstMessage String?         @map("custom_first_message")
  voiceId            String?         @map("voice_id")
  isEnabled          Boolean         @default(true) @map("is_enabled")
  canUpdateRsvp      Boolean         @default(true) @map("can_update_rsvp")
  lastSyncAt         DateTime?       @map("last_sync_at")
  syncStatus         String?         @map("sync_status")
  createdAt          DateTime        @default(now()) @map("created_at")
  updatedAt          DateTime        @default(now()) @updatedAt @map("updated_at")
  callJobs           VapiCallJob[]
  embeddings         VapiEmbedding[]
  weddingEvent       WeddingEvent    @relation(fields: [weddingEventId], references: [id], onDelete: Cascade)

  @@map("vapi_event_settings")
}

model VapiEmbedding {
  id             String            @id @default(cuid())
  vapiSettingsId String            @map("vapi_settings_id")
  contentType    String            @map("content_type")
  content        String
  createdAt      DateTime          @default(now()) @map("created_at")
  updatedAt      DateTime          @default(now()) @updatedAt @map("updated_at")
  vapiSettings   VapiEventSettings @relation(fields: [vapiSettingsId], references: [id], onDelete: Cascade)

  @@index([vapiSettingsId])
  @@index([contentType])
  @@map("vapi_embeddings")
}

model VapiCallJob {
  id             String            @id @default(cuid())
  weddingEventId String            @map("wedding_event_id")
  vapiSettingsId String            @map("vapi_settings_id")
  createdBy      String            @map("created_by")
  status         VapiJobStatus     @default(PENDING)
  totalGuests    Int               @map("total_guests")
  processedCount Int               @default(0) @map("processed_count")
  successCount   Int               @default(0) @map("success_count")
  failedCount    Int               @default(0) @map("failed_count")
  scheduledFor   DateTime?         @map("scheduled_for")
  startedAt      DateTime?         @map("started_at")
  completedAt    DateTime?         @map("completed_at")
  createdAt      DateTime          @default(now()) @map("created_at")
  errorMessage   String?           @map("error_message")
  creator        User              @relation(fields: [createdBy], references: [id])
  vapiSettings   VapiEventSettings @relation(fields: [vapiSettingsId], references: [id], onDelete: Cascade)
  callLogs       VapiCallLog[]

  @@index([weddingEventId])
  @@index([vapiSettingsId])
  @@index([createdBy])
  @@index([status])
  @@map("vapi_call_jobs")
}

model VapiCallLog {
  id             String         @id @default(cuid())
  callJobId      String?        @map("call_job_id")
  guestId        String         @map("guest_id")
  weddingEventId String         @map("wedding_event_id")
  vapiCallId     String?        @unique @map("vapi_call_id")
  phoneNumber    String         @map("phone_number")
  status         VapiCallStatus @default(PENDING)
  duration       Int?
  rsvpUpdated    Boolean        @default(false) @map("rsvp_updated")
  rsvpStatus     String?        @map("rsvp_status")
  guestCount     Int?           @map("guest_count")
  transcript     String?
  scheduledAt    DateTime?      @map("scheduled_at")
  startedAt      DateTime?      @map("started_at")
  endedAt        DateTime?      @map("ended_at")
  createdAt      DateTime       @default(now()) @map("created_at")
  callJob        VapiCallJob?   @relation(fields: [callJobId], references: [id])
  guest          Guest          @relation(fields: [guestId], references: [id], onDelete: Cascade)

  @@index([callJobId])
  @@index([guestId])
  @@index([weddingEventId])
  @@index([vapiCallId])
  @@index([status])
  @@map("vapi_call_logs")
}

// ============================================
// MANUAL CALL CENTER MODULE
// ============================================

model ManualCallLog {
  id             String           @id @default(cuid())
  weddingEventId String           @map("wedding_event_id")
  guestId        String           @map("guest_id")
  operatorId     String           @map("operator_id") // User making the call
  phoneNumber    String           @map("phone_number")

  // Call metadata
  status         ManualCallStatus @default(INITIATED)
  direction      String           @default("outbound")
  twilioCallSid  String?          @unique @map("twilio_call_sid")

  // Timing
  initiatedAt    DateTime         @default(now()) @map("initiated_at")
  connectedAt    DateTime?        @map("connected_at")
  endedAt        DateTime?        @map("ended_at")
  duration       Int?             // seconds

  // Call outcome
  notes          String?
  rsvpUpdated    Boolean          @default(false) @map("rsvp_updated")
  newRsvpStatus  String?          @map("new_rsvp_status")

  // Relations
  weddingEvent   WeddingEvent     @relation(fields: [weddingEventId], references: [id], onDelete: Cascade)
  guest          Guest            @relation(fields: [guestId], references: [id], onDelete: Cascade)
  operator       User             @relation(fields: [operatorId], references: [id])

  @@index([weddingEventId])
  @@index([guestId])
  @@index([operatorId])
  @@index([status])
  @@map("manual_call_logs")
}

model Supplier {
  id             String            @id @default(cuid())
  weddingEventId String            @map("wedding_event_id")
  name           String
  category       SupplierCategory
  status         SupplierStatus    @default(INQUIRY)
  contactName    String?           @map("contact_name")
  phoneNumber    String?           @map("phone_number")
  email          String?
  website        String?
  estimatedCost  Decimal?          @map("estimated_cost") @db.Decimal(10, 2)
  agreedPrice    Decimal?          @map("agreed_price") @db.Decimal(10, 2)
  currency       String            @default("ILS")
  notes          String?
  contractUrl    String?           @map("contract_url")
  bookedAt       DateTime?         @map("booked_at")
  createdAt      DateTime          @default(now()) @map("created_at")
  updatedAt      DateTime          @updatedAt @map("updated_at")
  payments       SupplierPayment[]
  weddingEvent   WeddingEvent      @relation(fields: [weddingEventId], references: [id], onDelete: Cascade)

  @@index([weddingEventId])
  @@index([category])
  @@index([status])
  @@map("suppliers")
}

model SupplierPayment {
  id          String        @id @default(cuid())
  supplierId  String        @map("supplier_id")
  amount      Decimal       @db.Decimal(10, 2)
  method      PaymentMethod @default(BANK_TRANSFER)
  description String?
  paidAt      DateTime      @map("paid_at")
  dueDate     DateTime?     @map("due_date")
  receiptUrl  String?       @map("receipt_url")
  notes       String?
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")
  supplier    Supplier      @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  @@index([supplierId])
  @@index([dueDate])
  @@map("supplier_payments")
}

model WhatsAppPhoneNumber {
  id                          String                     @id @default(cuid())
  phoneNumber                 String                     @unique @map("phone_number")
  displayName                 String?                    @map("display_name")
  isActive                    Boolean                    @default(false) @map("is_active")
  isDefault                   Boolean                    @default(false) @map("is_default")
  messagingProviderSettingsId String?                    @map("messaging_provider_settings_id")
  createdAt                   DateTime                   @default(now()) @map("created_at")
  updatedAt                   DateTime                   @default(now()) @updatedAt @map("updated_at")
  messagingProviderSettings   MessagingProviderSettings? @relation(fields: [messagingProviderSettingsId], references: [id], onDelete: Cascade)
  users                       User[]

  @@index([isActive])
  @@index([isDefault])
  @@map("whatsapp_phone_numbers")
}

model WhatsAppButtonResponse {
  id                String      @id @default(cuid())
  guestId           String      @map("guest_id")
  notificationLogId String?     @map("notification_log_id")
  responseType      String      @map("response_type") // "button" | "list"
  buttonId          String      @map("button_id")
  buttonTitle       String      @map("button_title")
  rsvpStatusSet     RsvpStatus? @map("rsvp_status_set")
  guestCountSet     Int?        @map("guest_count_set")
  processedAt       DateTime?   @map("processed_at")
  rawPayload        Json?       @map("raw_payload")
  createdAt         DateTime    @default(now()) @map("created_at")

  guest Guest @relation(fields: [guestId], references: [id], onDelete: Cascade)

  @@index([guestId])
  @@index([guestId, processedAt])
  @@map("whatsapp_button_responses")
}

model EventArchive {
  id              String   @id @default(cuid())
  userId          String   @map("user_id")
  originalEventId String   @unique @map("original_event_id")
  eventTitle      String   @map("event_title")
  eventDate       DateTime @map("event_date")
  r2Key           String   @map("r2_key")
  guestCount      Int      @default(0) @map("guest_count")
  archiveSize     Int?     @map("archive_size")
  archivedAt      DateTime @default(now()) @map("archived_at")
  createdAt       DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([archivedAt])
  @@map("event_archives")
}

enum UserRole {
  ROLE_PLATFORM_OWNER
  ROLE_WEDDING_OWNER
}

enum UserStatus {
  PENDING_APPROVAL
  ACTIVE
  SUSPENDED
}

enum PlanTier {
  FREE
  BASIC
  PREMIUM
  ADVANCED
  BUSINESS
}

enum RsvpStatus {
  PENDING
  ACCEPTED
  DECLINED
  MAYBE
}

enum NotificationType {
  INVITE
  REMINDER
  CONFIRMATION
  IMAGE_INVITE
  INTERACTIVE_INVITE
  INTERACTIVE_REMINDER
  GUEST_COUNT_REQUEST
  TRANSPORTATION_INVITE // Invite with transportation link
  EVENT_DAY // Event day reminder (table, navigation, gift)
  THANK_YOU // Thank you message after event
  TABLE_ASSIGNMENT // Table assignment notification
}

enum NotificationChannel {
  WHATSAPP
  SMS
  EMAIL
}

enum NotificationStatus {
  PENDING
  SENT
  DELIVERED
  FAILED
  UNDELIVERED // Message sent but delivery failed (e.g., 63049, 63024)
}

enum BulkJobStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum BackgroundType {
  COLOR
  IMAGE
  GRADIENT
}

enum CardStyle {
  FLAT
  ELEVATED
  BORDERED
  GLASS
}

enum DateDisplayStyle {
  CARD
  CALENDAR
  MINIMAL
}

enum CronJobType {
  PLAN_CHANGE
  BULK_MESSAGE
  EVENT_AUTO_CLOSE
}

enum CronJobStatus {
  SUCCESS
  FAILED
  SKIPPED
}

enum VapiCallStatus {
  PENDING
  CALLING
  COMPLETED
  FAILED
  NO_ANSWER
  BUSY
  CANCELLED
}

enum ManualCallStatus {
  INITIATED    // Call started
  RINGING      // Phone ringing
  CONNECTED    // Call answered
  COMPLETED    // Call ended successfully
  NO_ANSWER    // Not answered
  BUSY         // Line busy
  FAILED       // Technical failure
  CANCELLED    // User cancelled
}

enum VapiJobStatus {
  PENDING
  PROCESSING
  COMPLETED
  CANCELLED
  FAILED
}

enum SupplierCategory {
  VENUE
  CATERING
  PHOTOGRAPHY
  VIDEOGRAPHY
  DJ_MUSIC
  FLOWERS
  DECORATIONS
  CAKE
  DRESS_ATTIRE
  MAKEUP_HAIR
  INVITATIONS
  TRANSPORTATION
  ACCOMMODATION
  RABBI_OFFICIANT
  OTHER
}

enum SupplierStatus {
  INQUIRY
  QUOTE_RECEIVED
  NEGOTIATING
  BOOKED
  DEPOSIT_PAID
  CONFIRMED
  COMPLETED
  CANCELLED
}

enum PaymentMethod {
  CASH
  CREDIT_CARD
  BANK_TRANSFER
  CHECK
  OTHER
}

enum CollaboratorRole {
  VIEWER // Read-only access
  EDITOR // Can modify event data (default)
}

enum TaskStatus {
  BACKLOG
  TODO
  DOING
  DONE
}

// ============================================
// AUTOMATION FLOW MODULE ENUMS
// ============================================

enum AutomationTrigger {
  // Immediate Event Triggers (System automations - shown as active by default)
  RSVP_CONFIRMED // When guest confirms attendance - system automation
  RSVP_DECLINED // When guest declines - system automation
  RSVP_MAYBE // When guest says "maybe" - system automation, sends reminder next day

  // Time-Based Triggers (uses delayHours field, 1-24 hours)
  NO_RESPONSE_WHATSAPP // Guest hasn't responded to WhatsApp invite/reminder after X hours
  NO_RESPONSE_SMS // Guest hasn't responded to SMS invite/reminder after X hours
  BEFORE_EVENT // X hours before the event (1-24h)
  AFTER_EVENT // X hours after the event (1-24h)

  // Legacy triggers (for backwards compatibility - hidden in UI)
  RSVP_SENT // @deprecated - removed from UI
  NO_RESPONSE // @deprecated Use NO_RESPONSE_WHATSAPP or NO_RESPONSE_SMS
  NO_RESPONSE_24H // @deprecated Use NO_RESPONSE_WHATSAPP with delayHours=24
  NO_RESPONSE_48H // @deprecated Use NO_RESPONSE_WHATSAPP with delayHours=48
  NO_RESPONSE_72H // @deprecated Use NO_RESPONSE_WHATSAPP with delayHours=72
  EVENT_MORNING // @deprecated
  EVENT_DAY_MORNING // @deprecated
  DAY_AFTER_MORNING // @deprecated
  HOURS_BEFORE_EVENT_2 // @deprecated Use BEFORE_EVENT with delayHours=2
  DAY_AFTER_EVENT // @deprecated
}

enum AutomationAction {
  // WhatsApp Template Actions
  SEND_WHATSAPP_INVITE // Basic WhatsApp invite with RSVP link
  SEND_WHATSAPP_REMINDER // WhatsApp reminder message
  SEND_WHATSAPP_CONFIRMATION // Thank you/confirmation message
  SEND_WHATSAPP_IMAGE_INVITE // Interactive WhatsApp with wedding invitation image
  SEND_WHATSAPP_INTERACTIVE_REMINDER // Interactive reminder with buttons
  SEND_WHATSAPP_GUEST_COUNT // Guest count selection list
  SEND_TABLE_ASSIGNMENT // Table assignment with location info

  // Event Day & Thank You Templates
  SEND_WHATSAPP_EVENT_DAY // Event day reminder with table, address, gift link
  SEND_WHATSAPP_THANK_YOU // Thank you message after event

  // Custom Message Actions
  SEND_CUSTOM_WHATSAPP // Custom WhatsApp message (uses message editor)
  SEND_CUSTOM_SMS // Custom SMS message (uses message editor)

  // Legacy (for backwards compatibility - hidden in UI)
  SEND_WHATSAPP_INTERACTIVE_INVITE // @deprecated merged into SEND_WHATSAPP_IMAGE_INVITE
  SEND_WHATSAPP_TEMPLATE // @deprecated
  SEND_SMS_REMINDER // @deprecated Use SEND_CUSTOM_SMS
}

enum AutomationFlowStatus {
  DRAFT // Not yet activated
  ACTIVE // Running
  PAUSED // Temporarily stopped
  ARCHIVED // No longer in use
}

enum AutomationExecutionStatus {
  PENDING // Waiting to execute
  PROCESSING // Currently executing
  COMPLETED // Successfully completed
  FAILED // Execution failed
  SKIPPED // Skipped (condition not met)
}

// ============================================
// PDF INVITATION MODULE ENUMS
// ============================================

enum InvitationFieldType {
  // Guest & Couple Info
  GUEST_NAME // Guest's name (for personalized invitations)
  COUPLE_NAMES // Bride & Groom names
  COUPLE_NAMES_ENGLISH // Couple names in English (e.g., "SHAY & SAPIR")
  COUPLE_NAMES_HEBREW // Couple names in Hebrew (e.g., " & ")

  // Date & Time Fields
  EVENT_DATE // Event date (Gregorian, e.g., "28.01.26")
  EVENT_DATE_HEBREW // Hebrew date (e.g., "'  '"")
  DAY_OF_WEEK // Day of week (e.g., " ")
  EVENT_TIME // Generic event time
  RECEPTION_TIME // Reception start time (e.g., "  19:30")
  CEREMONY_TIME // Ceremony time (e.g., "  20:30")

  // Location Fields
  VENUE_NAME // Venue name only (e.g., "")
  VENUE_ADDRESS // Full address (e.g., "  5, ")
  STREET_ADDRESS // Street only (e.g., "  5")
  CITY // City name (e.g., "")

  // Family Names
  BRIDE_PARENTS // Bride's parents names (e.g., "  ")
  GROOM_PARENTS // Groom's parents names (e.g., "   ")
  BRIDE_FAMILY // Bride's family name (e.g., "  ")
  GROOM_FAMILY // Groom's family name (e.g., "  ")

  // Event Description
  EVENT_TYPE // Event type description (e.g., " ", "")
  INVITATION_TEXT // Main invitation text
  BLESSING_QUOTE // Quote/blessing at top (e.g., "    ...")

  // Custom
  CUSTOM // Custom text field
}

enum EventType {
  WEDDING // Wedding event
  HENNA // Henna ceremony
  ENGAGEMENT // Engagement party
  OTHER // Other celebration
}

// TemplateType enum removed - now using AI-powered image editing only

// ============================================
// GIFT PAYMENT MODULE ENUMS
// ============================================

enum GiftPaymentStatus {
  PENDING // Payment initiated but not completed
  PROCESSING // Payment being processed
  COMPLETED // Payment successful
  FAILED // Payment failed
  REFUNDED // Payment was refunded
}

model WeddingTask {
  id             String       @id @default(cuid())
  weddingEventId String       @map("wedding_event_id")
  title          String
  description    String?
  status         TaskStatus   @default(BACKLOG)
  position       Int          @default(0)
  dueDate        DateTime?    @map("due_date")
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @default(now()) @updatedAt @map("updated_at")
  weddingEvent   WeddingEvent @relation(fields: [weddingEventId], references: [id], onDelete: Cascade)
  notes          TaskNote[]

  @@index([weddingEventId])
  @@index([status])
  @@map("wedding_tasks")
}

model TaskNote {
  id        String      @id @default(cuid())
  taskId    String      @map("task_id")
  content   String
  createdAt DateTime    @default(now()) @map("created_at")
  updatedAt DateTime    @default(now()) @updatedAt @map("updated_at")
  task      WeddingTask @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@map("task_notes")
}

// ============================================
// AUTOMATION FLOW MODULE MODELS
// ============================================

// System pre-built automation flow templates
model AutomationFlowTemplate {
  id            String            @id @default(cuid())
  name          String            @unique
  nameHe        String            @map("name_he")
  description   String?
  descriptionHe String?           @map("description_he")
  trigger       AutomationTrigger
  action        AutomationAction
  isActive      Boolean           @default(true) @map("is_active")
  sortOrder     Int               @default(0) @map("sort_order")
  createdAt     DateTime          @default(now()) @map("created_at")
  updatedAt     DateTime          @default(now()) @updatedAt @map("updated_at")

  flows AutomationFlow[]

  @@index([isActive])
  @@map("automation_flow_templates")
}

// User/Event-level automation flows (can be from template or custom)
model AutomationFlow {
  id             String               @id @default(cuid())
  weddingEventId String               @map("wedding_event_id")
  name           String
  trigger        AutomationTrigger
  action         AutomationAction
  status         AutomationFlowStatus @default(DRAFT)
  templateId     String?              @map("template_id") // If created from a template
  customMessage  String?              @map("custom_message") // Optional custom message override
  delayHours     Int?                 @map("delay_hours") // For time-based triggers (NO_RESPONSE, BEFORE_EVENT, AFTER_EVENT)
  templateStyle  String?              @map("template_style") // WhatsApp template style: formal, friendly, short
  createdAt      DateTime             @default(now()) @map("created_at")
  updatedAt      DateTime             @default(now()) @updatedAt @map("updated_at")

  weddingEvent WeddingEvent              @relation(fields: [weddingEventId], references: [id], onDelete: Cascade)
  template     AutomationFlowTemplate?   @relation(fields: [templateId], references: [id], onDelete: SetNull)
  executions   AutomationFlowExecution[]

  @@index([weddingEventId])
  @@index([status])
  @@index([trigger])
  @@index([templateId])
  @@map("automation_flows")
}

// Tracks execution of automation flows per guest
model AutomationFlowExecution {
  id           String                    @id @default(cuid())
  flowId       String                    @map("flow_id")
  guestId      String                    @map("guest_id")
  status       AutomationExecutionStatus @default(PENDING)
  scheduledFor DateTime?                 @map("scheduled_for")
  executedAt   DateTime?                 @map("executed_at")
  errorMessage String?                   @map("error_message")
  retryCount   Int                       @default(0) @map("retry_count")
  createdAt    DateTime                  @default(now()) @map("created_at")
  updatedAt    DateTime                  @default(now()) @updatedAt @map("updated_at")

  flow  AutomationFlow @relation(fields: [flowId], references: [id], onDelete: Cascade)
  guest Guest          @relation(fields: [guestId], references: [id], onDelete: Cascade)

  @@unique([flowId, guestId])
  @@index([flowId])
  @@index([guestId])
  @@index([status])
  @@index([scheduledFor])
  @@index([status, scheduledFor])
  @@map("automation_flow_executions")
}

// ============================================
// INVITATION MODULE MODELS (AI-Powered)
// ============================================

// Admin-created invitation templates (AI image editing based)
model InvitationTemplate {
  id            String    @id @default(cuid())
  name          String
  nameHe        String    @map("name_he")
  description   String?
  descriptionHe String?   @map("description_he")
  eventType     EventType @default(WEDDING) @map("event_type")

  // Template image URL (R2) - the reference image for AI editing
  imageUrl String @default("") @map("image_url")

  // Preview/thumbnail image URL (R2)
  thumbnailUrl String? @map("thumbnail_url")

  // Original PDF URL (R2) - kept for reference
  pdfUrl String? @map("pdf_url")

  isActive  Boolean  @default(true) @map("is_active")
  sortOrder Int      @default(0) @map("sort_order")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  fields      InvitationTemplateField[]
  generations GeneratedInvitation[]

  @@index([eventType])
  @@index([isActive])
  @@map("invitation_templates")
}

// Define which fields are editable in each template (for AI text replacement)
model InvitationTemplateField {
  id            String              @id @default(cuid())
  templateId    String              @map("template_id")
  fieldType     InvitationFieldType @map("field_type")
  label         String // Display label for the field (English)
  labelHe       String?             @map("label_he") // Display label (Hebrew)
  placeholder   String? // Placeholder/hint text for input
  isRequired    Boolean             @default(true) @map("is_required")
  originalValue String              @default("") @map("original_value") // The original text in the template image
  sortOrder     Int                 @default(0) @map("sort_order")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  template InvitationTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([templateId])
  @@map("invitation_template_fields")
}

// User-generated invitations
model GeneratedInvitation {
  id             String   @id @default(cuid())
  weddingEventId String   @map("wedding_event_id")
  templateId     String   @map("template_id")
  pngUrl         String?  @map("png_url") // R2 URL to generated PNG (primary output)
  pdfUrl         String?  @map("pdf_url") // R2 URL to generated PDF (optional)
  fieldValues    Json     @map("field_values") // JSON of field values used
  createdAt      DateTime @default(now()) @map("created_at")

  weddingEvent WeddingEvent       @relation(fields: [weddingEventId], references: [id], onDelete: Cascade)
  template     InvitationTemplate @relation(fields: [templateId], references: [id])

  @@index([weddingEventId])
  @@index([templateId])
  @@map("generated_invitations")
}

// ============================================
// GIFT PAYMENT MODULE MODELS
// ============================================

// Per-event gift payment settings
model GiftPaymentSettings {
  id                String   @id @default(cuid())
  weddingEventId    String   @unique @map("wedding_event_id")
  isEnabled         Boolean  @default(false) @map("is_enabled")
  currency          String   @default("ILS")
  minAmount         Decimal  @default(50) @map("min_amount") @db.Decimal(10, 2)
  maxAmount         Decimal  @default(10000) @map("max_amount") @db.Decimal(10, 2)
  suggestedAmounts  Json?    @map("suggested_amounts") // e.g., [100, 200, 500, 1000]
  allowCustomAmount Boolean  @default(true) @map("allow_custom_amount")
  thankYouMessage   String?  @map("thank_you_message")
  thankYouMessageHe String?  @map("thank_you_message_he")
  // External gift provider settings
  useExternalProvider    Boolean  @default(false) @map("use_external_provider")
  externalProviderUrl    String?  @map("external_provider_url")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @default(now()) @updatedAt @map("updated_at")

  weddingEvent WeddingEvent @relation(fields: [weddingEventId], references: [id], onDelete: Cascade)

  @@map("gift_payment_settings")
}

// Individual gift payments
model GiftPayment {
  id              String            @id @default(cuid())
  weddingEventId  String            @map("wedding_event_id")
  guestId         String?           @map("guest_id") // Optional - for linked guests
  guestName       String            @map("guest_name") // Name entered by payer
  guestEmail      String?           @map("guest_email")
  guestPhone      String?           @map("guest_phone")
  amount          Decimal           @map("amount") @db.Decimal(10, 2)
  serviceFee      Decimal           @map("service_fee") @db.Decimal(10, 2) // 8% fee
  totalCharged    Decimal           @map("total_charged") @db.Decimal(10, 2) // amount + serviceFee
  currency        String            @default("ILS")
  status          GiftPaymentStatus @default(PENDING)
  greetingMessage String?           @map("greeting_message")
  greetingImage   String?           @map("greeting_image") // R2 URL to image
  isManual        Boolean           @default(false) @map("is_manual") // Cash gift added manually
  paidAt          DateTime?         @map("paid_at")
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @default(now()) @updatedAt @map("updated_at")

  weddingEvent WeddingEvent         @relation(fields: [weddingEventId], references: [id], onDelete: Cascade)
  guest        Guest?               @relation(fields: [guestId], references: [id], onDelete: SetNull)
  transactions PaymentTransaction[]

  @@index([weddingEventId])
  @@index([guestId])
  @@index([status])
  @@map("gift_payments")
}

// Payment provider transaction details
model PaymentTransaction {
  id                    String   @id @default(cuid())
  giftPaymentId         String   @map("gift_payment_id")
  provider              String   @default("meshulam") // Payment provider name
  providerTransactionId String?  @unique @map("provider_transaction_id")
  providerPageCode      String?  @map("provider_page_code")
  providerResponse      Json?    @map("provider_response")
  status                String // Provider-specific status
  errorCode             String?  @map("error_code")
  errorMessage          String?  @map("error_message")
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @default(now()) @updatedAt @map("updated_at")

  giftPayment GiftPayment @relation(fields: [giftPaymentId], references: [id], onDelete: Cascade)

  @@index([giftPaymentId])
  @@index([providerTransactionId])
  @@map("payment_transactions")
}

// ============================================
// SYSTEM SETTINGS
// ============================================

// Key-value store for system-wide settings
model SystemSetting {
  key       String   @id
  value     String   @db.Text
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  @@map("system_settings")
}
